"use strict";(globalThis.webpackChunkphysical_ai_humanoid_robotics_book=globalThis.webpackChunkphysical_ai_humanoid_robotics_book||[]).push([[1169],{1169:(e,t,s)=>{s.r(t),s.d(t,{ChatConversationContext:()=>r.ChatConversationContext,ChatInputBar:()=>M,ChatKitProvider:()=>g,ChatLauncherButton:()=>y,ChatMessageBubble:()=>N,ChatMessageList:()=>T,ChatPanel:()=>A,ChatUIContext:()=>i,ErrorBubble:()=>L,MarkdownRenderer:()=>E,MobileChatDrawer:()=>P,PortalManager:()=>w,SafeChatKitProvider:()=>f,SelectionTooltip:()=>$,chatService:()=>I,handleStreamError:()=>n.handleStreamError,processStreamEvent:()=>n.processStreamEvent,useChatConversation:()=>u,useChatKit:()=>p,useChatMessages:()=>v,useChatUI:()=>c,useStream:()=>b});var r={};s.r(r),s.d(r,{Ay:()=>h,HJ:()=>u});var n={};s.r(n);var a=s(6540),o=s(4848);const i=(0,a.createContext)(null),c=()=>{const e=(0,a.useContext)(i);if(!e)throw new Error("useChatUI must be used within a ChatUIProvider");return e},l=({children:e})=>{const[t,s]=(0,a.useState)(!1),[r,n]=(0,a.useState)(!1),c={isOpen:t,openChat:()=>s(!0),closeChat:()=>s(!1),toggleChat:()=>s(!t),isMobile:r,setIsMobile:n};return(0,o.jsx)(i.Provider,{value:c,children:e})},d=(0,a.createContext)(null),u=()=>{const e=(0,a.useContext)(d);if(!e)throw new Error("useChatConversation must be used within a ChatConversationProvider");return e},h=({children:e})=>{const[t,s]=(0,a.useState)([]),[r,n]=(0,a.useState)(!1),[i,c]=(0,a.useState)(null),[l,u]=(0,a.useState)(()=>"undefined"!=typeof window&&localStorage.getItem("chatkit-session-id")||`session-${Date.now()}`),h=(0,a.useCallback)(e=>{s(t=>[...t,e])},[]),m=(0,a.useCallback)((e,t)=>{s(s=>s.map(s=>s.id===e?{...s,...t}:s))},[]),g=(0,a.useCallback)(()=>{s([])},[]),p=(0,a.useCallback)(e=>{n(e)},[]),x={messages:t,addMessage:h,updateMessage:m,clearMessages:g,isStreaming:r,setIsStreaming:(0,a.useCallback)(e=>{n(e)},[]),setStreamingState:p,selectedText:i,setSelectedText:c,sessionId:l};return(0,o.jsx)(d.Provider,{value:x,children:e})},m=(0,a.createContext)(null),g=({children:e})=>{const[t,s]=(0,a.useState)(null),[r,n]=(0,a.useState)(!0),[i,c]=(0,a.useState)(null),[d,u]=(0,a.useState)([]),[g,p]=(0,a.useState)(!1),[x,f]=(0,a.useState)(null),[w,v]=(0,a.useState)(()=>"undefined"!=typeof window&&localStorage.getItem("chatkit-session-id")||`session-${Date.now()}`);(0,a.useEffect)(()=>{(async()=>{try{const e=await fetch("/api/config/chatkit");if(!e.ok)throw new Error(`Failed to load config: ${e.status}`);const t=await e.json();s(t)}catch(e){console.error("Error loading ChatKit config:",e),c(e.message),s({theme:"light",maxTokens:1e3,temperature:.7})}finally{n(!1)}})(),"undefined"!=typeof window&&localStorage.setItem("chatkit-session-id",w)},[w]);const b={config:t,isLoading:r,error:i,messages:d,addMessage:(0,a.useCallback)(e=>{u(t=>[...t,e])},[]),updateMessage:(0,a.useCallback)((e,t)=>{u(s=>s.map(s=>s.id===e?{...s,...t}:s))},[]),clearMessages:(0,a.useCallback)(()=>{u([])},[]),isStreaming:g,setIsStreaming:p,selectedText:x,setSelectedText:f,sessionId:w};return(0,o.jsx)(m.Provider,{value:b,children:(0,o.jsx)(l,{children:(0,o.jsx)(h,{children:e})})})},p=()=>{const e=(0,a.useContext)(m);if(!e)throw new Error("useChatKit must be used within a ChatKitProvider");return e},x=({children:e})=>((0,a.useEffect)(()=>{if("undefined"!=typeof document){const e=document.createElement("div");return e.setAttribute("id","chatkit-portal-root"),e.style.all="initial",document.body.appendChild(e),()=>{document.body.removeChild(e)}}},[]),e),f=({children:e})=>(0,o.jsx)(x,{children:(0,o.jsx)(g,{children:e})}),w=({children:e})=>((0,a.useEffect)(()=>{if("undefined"!=typeof document){let e=document.getElementById("chatkit-portal-root");return e||(e=document.createElement("div"),e.setAttribute("id","chatkit-portal-root"),e.style.all="initial",document.body.appendChild(e)),()=>{const e=document.getElementById("chatkit-portal-root");e&&e.parentNode&&e.parentNode.removeChild(e)}}},[]),(0,o.jsx)(g,{children:e})),v=()=>{const e=u();if(!e)throw new Error("useChatMessages must be used within a ChatConversationProvider");return e},b=()=>{const{updateMessage:e,setIsStreaming:t}=p(),[s,r]=(0,a.useState)(null);return{startStream:(0,a.useCallback)(async(s,n,a)=>{t(!0);try{const t=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!t.ok)throw new Error(`Stream request failed: ${t.status}`);const r=t.body?.getReader();if(!r)throw new Error("Readable stream not supported");const i=new TextDecoder;let c="";for(;;){const{done:t,value:n}=await r.read();if(t)break;c+=i.decode(n,{stream:!0});const a=c.split("\n");c=a.pop()||"";for(const r of a)if(r.startsWith("data: ")){const t=r.slice(6);if("[DONE]"===t)break;try{const r=JSON.parse(t);r.token&&e(s,{content:e=>(e||"")+r.token}),"sources"===r.type&&r.data&&e(s,{sources:r.data}),"error"===r.type&&r.message&&e(s,{error:r.message})}catch(o){console.warn("Could not parse stream data:",r)}}}}catch(i){console.error("Stream error:",i),e(s,{error:i.message})}finally{t(!1),r(null)}},[e,t]),cancelStream:(0,a.useCallback)(()=>{s&&(s.cancel(),r(null),t(!1))},[s,t]),isStreaming:p().isStreaming}},y=()=>{const{isOpen:e,toggleChat:t}=c(),{isStreaming:s}=u();return(0,o.jsx)("button",{className:`chat-launcher-button ${e?"open":""} ${s?"streaming":""}`,onClick:t,"aria-label":e?"Close chat":"Open chat",title:e?"Close chat":"Open chat AI assistant",disabled:s,children:s?(0,o.jsxs)("div",{className:"loading-spinner",children:[(0,o.jsx)("div",{className:"spinner-dot"}),(0,o.jsx)("div",{className:"spinner-dot"}),(0,o.jsx)("div",{className:"spinner-dot"})]}):(0,o.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"chat-icon",children:(0,o.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})})};var j=s(7074),C=s(3092),k=s(1911),S=s(2918);const E=({content:e})=>{const t=e||"";return(0,o.jsx)("div",{className:"markdown-renderer",children:(0,o.jsx)(j.oz,{remarkPlugins:[C.A],rehypePlugins:[k.A,S.A],components:{code(e){const{children:t,className:s,...r}=e;return/language-(\w+)/.exec(s||"")?(0,o.jsx)("pre",{...r,className:s,children:(0,o.jsx)("code",{className:s,children:t})}):(0,o.jsx)("code",{...r,className:s,children:t})},a(e){const{href:t,children:s,...r}=e;return(0,o.jsx)("a",{...r,href:t,target:"_blank",rel:"noopener noreferrer",children:s})},table:e=>(0,o.jsx)("div",{className:"table-container",children:(0,o.jsx)("table",{...e})})},children:t})})},N=({message:e})=>{const t="user"===e.role,s="assistant"===e.role,r=e.error,n=e.isStreaming;return(0,o.jsxs)("div",{className:`message-bubble ${t?"user-message":s?"bot-message":""} ${r?"error-message":""}`,children:[(0,o.jsx)("div",{className:"message-avatar",children:t?(0,o.jsx)("span",{className:"user-avatar",children:"\ud83d\udc64"}):(0,o.jsx)("span",{className:"bot-avatar",children:"\ud83e\udd16"})}),(0,o.jsx)("div",{className:"message-content",children:r?(0,o.jsxs)("div",{className:"error-content",children:[(0,o.jsx)("strong",{children:"Error:"})," ",e.error]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(E,{content:e.content||e.text||""}),n&&(0,o.jsxs)("div",{className:"typing-indicator",children:[(0,o.jsx)("span",{}),(0,o.jsx)("span",{}),(0,o.jsx)("span",{})]}),e.sources&&e.sources.length>0&&(0,o.jsx)("div",{className:"message-sources",children:(0,o.jsxs)("details",{children:[(0,o.jsx)("summary",{children:"Sources"}),(0,o.jsx)("ul",{children:e.sources.map((e,t)=>(0,o.jsx)("li",{children:e.title||e.text?.substring(0,50)+"..."},t))})]})})]})})]})},T=({messages:e})=>{const t=(0,a.useRef)(null),s=(0,a.useRef)(null);(0,a.useEffect)(()=>{r()},[e]);const r=()=>{t.current?.scrollIntoView({behavior:"smooth"})};return(0,o.jsxs)("div",{className:"chat-message-list",ref:s,onScroll:()=>{if(s.current){const{scrollTop:e,scrollHeight:t,clientHeight:r}=s.current;if(t-e-r>100)return}},children:[e.map(e=>(0,o.jsx)(N,{message:e},e.id)),(0,o.jsx)("div",{ref:t})]})},I={sendMessage:async(e,t)=>{try{if(t){const r=await fetch("/api/v1/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e.message,session_id:e.sessionId,max_context:5})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const n=r.body.getReader(),a=new TextDecoder;let o="";for(;;){const{done:e,value:r}=await n.read();if(e)break;o+=a.decode(r,{stream:!0});const i=o.split("\n");o=i.pop()||"";for(const n of i)if(n.startsWith("data: "))try{const e=JSON.parse(n.slice(6));if("token"===e.type&&t)t(e.content);else if("sources"===e.type)console.log("Sources received:",e.sources);else if("complete"===e.type)break}catch(s){console.warn("Malformed JSON in stream:",n)}}return{success:!0}}{const t=await fetch("/api/v1/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e.message,session_id:e.sessionId,max_context:5})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}}catch(r){throw console.error("Error sending message:",r),r}},sendSelectedText:async e=>{try{const t=await fetch("/api/v1/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`Based on this selected text: "${e.selectedText}", please provide relevant information or answer questions about it.`,session_id:e.sessionId,max_context:5})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}catch(t){throw console.error("Error sending selected text:",t),t}},getConfig:async()=>{try{const e=await fetch("/api/v1/config/chatkit");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching config:",e),e}},checkHealth:async()=>{try{return(await fetch("/api/v1/health")).ok}catch(e){return console.error("Error checking health:",e),!1}}},M=()=>{const[e,t]=(0,a.useState)(""),[s,r]=(0,a.useState)(!1),n=(0,a.useRef)(null),{addMessage:i,selectedText:c,sessionId:l,updateMessage:d,setIsStreaming:h}=u(),m=(0,a.useCallback)(()=>{n.current&&(n.current.style.height="auto",n.current.style.height=Math.min(n.current.scrollHeight,150)+"px")},[]),g=async()=>{if(e.trim()&&!s){r(!0);try{const s=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;i({id:s,role:"user",content:e,timestamp:new Date});const r={message:e,context:{selected_text:c||null,page:"undefined"!=typeof window?window.location.pathname:""},sessionId:l},a=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;i({id:a,role:"assistant",content:"",timestamp:new Date,isStreaming:!0}),h(!0),await I.sendMessage(r,async e=>{d(a,{content:t=>t+e,isStreaming:!0})}),d(a,{isStreaming:!1}),t(""),n.current&&(n.current.style.height="auto")}catch(a){console.error("Error sending message:",a),i({id:`error-${Date.now()}`,role:"system",content:`Error: ${a.message}`,timestamp:new Date,error:!0})}finally{r(!1),h(!1)}}},p=s;return(0,o.jsxs)("div",{className:"chat-input-bar",children:[c&&(0,o.jsxs)("div",{className:"selected-text-indicator",children:['Using selected text as context: "',c.substring(0,50),c.length>50?"...":"",'"']}),(0,o.jsxs)("div",{className:"input-container",children:[(0,o.jsx)("textarea",{ref:n,value:e,onChange:e=>{t(e.target.value),m()},onKeyDown:t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),!s&&e.trim()&&g())},placeholder:c?"Ask about the selected text...":"Message AI assistant...",className:"chat-textarea",disabled:p,rows:1}),(0,o.jsx)("button",{onClick:g,disabled:p||!e.trim(),className:"send-button "+(e.trim()?"active":""),"aria-label":"Send message",children:(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),(0,o.jsx)("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]})]})},A=()=>{const{isOpen:e,closeChat:t}=c(),{isMobile:s}=c(),{messages:r}=u(),n=(0,a.useRef)(null);return(0,a.useEffect)(()=>{const s=e=>{!n.current||n.current.contains(e.target)||e.target.closest(".chat-launcher-button")||t()};return e&&document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[e,t]),(0,a.useEffect)(()=>{const s=e=>{"Escape"===e.key&&t()};return e&&document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[e,t]),!e||s?null:(0,o.jsx)("div",{className:"chat-panel-backdrop",children:(0,o.jsxs)("div",{className:"chat-panel",ref:n,children:[(0,o.jsxs)("div",{className:"chat-header",children:[(0,o.jsx)("h3",{children:"AI Assistant"}),(0,o.jsx)("button",{className:"close-button",onClick:t,"aria-label":"Close chat",children:"\xd7"})]}),(0,o.jsxs)("div",{className:"chat-content",children:[(0,o.jsx)(T,{messages:r}),(0,o.jsx)(M,{})]})]})})},P=()=>{const{isOpen:e,closeChat:t,isMobile:s}=c(),{messages:r}=u(),n=(0,a.useRef)(null);return(0,a.useEffect)(()=>{const r=e=>{"Escape"===e.key&&t()};return e&&s&&document.addEventListener("keydown",r),()=>{document.removeEventListener("keydown",r)}},[e,s,t]),e&&s?(0,o.jsx)("div",{className:"mobile-drawer-overlay",children:(0,o.jsxs)("div",{className:"mobile-drawer",ref:n,children:[(0,o.jsxs)("div",{className:"mobile-drawer-header",children:[(0,o.jsx)("button",{className:"back-button",onClick:t,"aria-label":"Back to content",children:"\u2190"}),(0,o.jsx)("h3",{children:"AI Assistant"}),(0,o.jsx)("div",{className:"header-spacer"})]}),(0,o.jsxs)("div",{className:"mobile-drawer-content",children:[(0,o.jsx)(T,{messages:r}),(0,o.jsx)(M,{})]})]})}):null},$=()=>{const[e,t]=(0,a.useState)(!1),[s,r]=(0,a.useState)({top:0,left:0}),[n,i]=(0,a.useState)(""),[l,d]=(0,a.useState)(!1),h=(0,a.useRef)(null),{openChat:m}=c(),{setSelectedText:g}=u();(0,a.useEffect)(()=>{const e=()=>{const e=window.getSelection(),s=e.toString().trim();if(s.length>0&&s.length<1e3){const n=e.getRangeAt(0).getBoundingClientRect();r({top:n.top+window.scrollY-40,left:n.left+window.scrollX+n.width/2}),i(s),t(!0)}else t(!1)},s=()=>{setTimeout(e,0)};return document.addEventListener("mouseup",s),document.addEventListener("keyup",e=>{"Escape"===e.key&&t(!1)}),()=>{document.removeEventListener("mouseup",s),document.removeEventListener("keyup",e=>{"Escape"===e.key&&t(!1)})}},[]),(0,a.useEffect)(()=>{const s=e=>{h.current&&!h.current.contains(e.target)&&t(!1)};return e&&document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[e]);return e&&n?(0,o.jsx)("div",{className:"selection-tooltip "+(l?"processing":""),style:{top:`${s.top}px`,left:`${s.left}px`,transform:"translateX(-50%)"},ref:h,children:(0,o.jsx)("button",{className:"ask-ai-button",onClick:async()=>{if(n&&!l){d(!0);try{g(n),m(),window.getSelection().removeAllRanges()}catch(e){console.error("Error handling selected text:",e)}finally{d(!1),t(!1)}}},disabled:l,"aria-label":"Ask AI about selected text",children:l?(0,o.jsx)("span",{children:"Asking AI..."}):(0,o.jsx)("span",{children:"Ask AI about this"})})}):null},L=({message:e,onRetry:t,showRetry:s=!0})=>(0,o.jsxs)("div",{className:"error-bubble",children:[(0,o.jsxs)("div",{className:"error-content",children:[(0,o.jsx)("div",{className:"error-icon",children:"\u26a0\ufe0f"}),(0,o.jsx)("div",{className:"error-message",children:e})]}),s&&(0,o.jsx)("div",{className:"error-actions",children:(0,o.jsx)("button",{className:"retry-button",onClick:()=>{t&&t()},children:"Try Again"})})]})}}]);