"use strict";(globalThis.webpackChunkphysical_ai_humanoid_robotics_book=globalThis.webpackChunkphysical_ai_humanoid_robotics_book||[]).push([[9525],{9525:(e,t,s)=>{s.r(t),s.d(t,{ChatConversationContext:()=>n.ChatConversationContext,ChatInputBar:()=>$,ChatKitProvider:()=>x,ChatLauncherButton:()=>j,ChatMessageBubble:()=>A,ChatMessageList:()=>I,ChatPanel:()=>P,ChatUIContext:()=>i,ErrorBubble:()=>R,MarkdownRenderer:()=>T,MobileChatDrawer:()=>_,PortalManager:()=>b,SafeChatKitProvider:()=>v,SelectionTooltip:()=>L,chatService:()=>M,handleStreamError:()=>r.handleStreamError,processStreamEvent:()=>r.processStreamEvent,useChatConversation:()=>u,useChatKit:()=>f,useChatMessages:()=>y,useChatUI:()=>c,useStream:()=>C});var n={};s.r(n),s.d(n,{Ay:()=>h,HJ:()=>u});var r={};s.r(r);var a=s(6540),o=s(4848);const i=(0,a.createContext)(null),c=()=>{const e=(0,a.useContext)(i);if(!e)throw new Error("useChatUI must be used within a ChatUIProvider");return e},l=({children:e})=>{const[t,s]=(0,a.useState)(!1),[n,r]=(0,a.useState)(!1),c={isOpen:t,openChat:()=>s(!0),closeChat:()=>s(!1),toggleChat:()=>s(!t),isMobile:n,setIsMobile:r};return(0,o.jsx)(i.Provider,{value:c,children:e})},d=(0,a.createContext)(null),u=()=>{const e=(0,a.useContext)(d);if(!e)throw new Error("useChatConversation must be used within a ChatConversationProvider");return e},h=({children:e})=>{const[t,s]=(0,a.useState)([]),[n,r]=(0,a.useState)(!1),[i,c]=(0,a.useState)(null),[l,u]=(0,a.useState)(()=>"undefined"!=typeof window&&localStorage.getItem("chatkit-session-id")||`session-${Date.now()}`),h=(0,a.useCallback)(e=>{s(t=>[...t,e])},[]),m=(0,a.useCallback)((e,t)=>{s(s=>s.map(s=>s.id===e?{...s,...t}:s))},[]),g=(0,a.useCallback)(()=>{s([])},[]),p=(0,a.useCallback)(e=>{r(e)},[]),x={messages:t,addMessage:h,updateMessage:m,clearMessages:g,isStreaming:n,setIsStreaming:(0,a.useCallback)(e=>{r(e)},[]),setStreamingState:p,selectedText:i,setSelectedText:c,sessionId:l};return(0,o.jsx)(d.Provider,{value:x,children:e})},m="https://aman778-rag-chatbot-backend.hf.space",g="undefined"!=typeof window&&(window.ENV?.REACT_APP_BACKEND_URL||window.ENV?.BACKEND_URL||process.env.REACT_APP_BACKEND_URL||process.env.BACKEND_URL)||m,p=(0,a.createContext)(null),x=({children:e})=>{const[t,s]=(0,a.useState)(null),[n,r]=(0,a.useState)(!0),[i,c]=(0,a.useState)(null),[d,u]=(0,a.useState)([]),[m,x]=(0,a.useState)(!1),[f,w]=(0,a.useState)(null),[v,b]=(0,a.useState)(()=>"undefined"!=typeof window&&localStorage.getItem("chatkit-session-id")||`session-${Date.now()}`);(0,a.useEffect)(()=>{(async()=>{try{const e=await fetch(`${g}/api/v1/config/chatkit`);if(!e.ok)throw new Error(`Failed to load config: ${e.status}`);const t=await e.json();s(t)}catch(e){console.error("Error loading ChatKit config:",e),c(e.message),s({theme:"light",maxTokens:1e3,temperature:.7})}finally{r(!1)}})(),"undefined"!=typeof window&&localStorage.setItem("chatkit-session-id",v)},[v]);const y={config:t,isLoading:n,error:i,messages:d,addMessage:(0,a.useCallback)(e=>{u(t=>[...t,e])},[]),updateMessage:(0,a.useCallback)((e,t)=>{u(s=>s.map(s=>s.id===e?{...s,...t}:s))},[]),clearMessages:(0,a.useCallback)(()=>{u([])},[]),isStreaming:m,setIsStreaming:x,selectedText:f,setSelectedText:w,sessionId:v};return(0,o.jsx)(p.Provider,{value:y,children:(0,o.jsx)(l,{children:(0,o.jsx)(h,{children:e})})})},f=()=>{const e=(0,a.useContext)(p);if(!e)throw new Error("useChatKit must be used within a ChatKitProvider");return e},w=({children:e})=>((0,a.useEffect)(()=>{if("undefined"!=typeof document){const e=document.createElement("div");return e.setAttribute("id","chatkit-portal-root"),e.style.all="initial",document.body.appendChild(e),()=>{document.body.removeChild(e)}}},[]),e),v=({children:e})=>(0,o.jsx)(w,{children:(0,o.jsx)(x,{children:e})}),b=({children:e})=>((0,a.useEffect)(()=>{if("undefined"!=typeof document){let e=document.getElementById("chatkit-portal-root");return e||(e=document.createElement("div"),e.setAttribute("id","chatkit-portal-root"),e.style.all="initial",document.body.appendChild(e)),()=>{const e=document.getElementById("chatkit-portal-root");e&&e.parentNode&&e.parentNode.removeChild(e)}}},[]),(0,o.jsx)(x,{children:e})),y=()=>{const e=u();if(!e)throw new Error("useChatMessages must be used within a ChatConversationProvider");return e},C=()=>{const{updateMessage:e,setIsStreaming:t}=f(),[s,n]=(0,a.useState)(null);return{startStream:(0,a.useCallback)(async(s,r,a)=>{t(!0);try{const t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!t.ok)throw new Error(`Stream request failed: ${t.status}`);const n=t.body?.getReader();if(!n)throw new Error("Readable stream not supported");const i=new TextDecoder;let c="";for(;;){const{done:t,value:r}=await n.read();if(t)break;c+=i.decode(r,{stream:!0});const a=c.split("\n");c=a.pop()||"";for(const n of a)if(n.startsWith("data: ")){const t=n.slice(6);if("[DONE]"===t)break;try{const n=JSON.parse(t);n.token&&e(s,{content:e=>(e||"")+n.token}),"sources"===n.type&&n.data&&e(s,{sources:n.data}),"error"===n.type&&n.message&&e(s,{error:n.message})}catch(o){console.warn("Could not parse stream data:",n)}}}}catch(i){console.error("Stream error:",i),e(s,{error:i.message})}finally{t(!1),n(null)}},[e,t]),cancelStream:(0,a.useCallback)(()=>{s&&(s.cancel(),n(null),t(!1))},[s,t]),isStreaming:f().isStreaming}},j=()=>{const{isOpen:e,toggleChat:t}=c(),{isStreaming:s}=u();return(0,o.jsx)("button",{className:`chat-launcher-button ${e?"open":""} ${s?"streaming":""}`,onClick:t,"aria-label":e?"Close chat":"Open chat",title:e?"Close chat":"Open chat AI assistant",disabled:s,children:s?(0,o.jsxs)("div",{className:"loading-spinner",children:[(0,o.jsx)("div",{className:"spinner-dot"}),(0,o.jsx)("div",{className:"spinner-dot"}),(0,o.jsx)("div",{className:"spinner-dot"})]}):(0,o.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"chat-icon",children:(0,o.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})})};var k=s(7074),S=s(3092),E=s(1911),N=s(2918);const T=({content:e})=>{const t=e||"";return(0,o.jsx)("div",{className:"markdown-renderer",children:(0,o.jsx)(k.oz,{remarkPlugins:[S.A],rehypePlugins:[E.A,N.A],components:{code(e){const{children:t,className:s,...n}=e;return/language-(\w+)/.exec(s||"")?(0,o.jsx)("pre",{...n,className:s,children:(0,o.jsx)("code",{className:s,children:t})}):(0,o.jsx)("code",{...n,className:s,children:t})},a(e){const{href:t,children:s,...n}=e;return(0,o.jsx)("a",{...n,href:t,target:"_blank",rel:"noopener noreferrer",children:s})},table:e=>(0,o.jsx)("div",{className:"table-container",children:(0,o.jsx)("table",{...e})})},children:t})})},A=({message:e})=>{const t="user"===e.role,s="assistant"===e.role,n=e.error,r=e.isStreaming;return(0,o.jsxs)("div",{className:`message-bubble ${t?"user-message":s?"bot-message":""} ${n?"error-message":""}`,children:[(0,o.jsx)("div",{className:"message-avatar",children:t?(0,o.jsx)("span",{className:"user-avatar",children:"\ud83d\udc64"}):(0,o.jsx)("span",{className:"bot-avatar",children:"\ud83e\udd16"})}),(0,o.jsx)("div",{className:"message-content",children:n?(0,o.jsx)("div",{className:"error-content",children:(0,o.jsx)(T,{content:e.content||e.error||"An error occurred"})}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(T,{content:e.content||e.text||""}),r&&(0,o.jsxs)("div",{className:"typing-indicator",children:[(0,o.jsx)("span",{}),(0,o.jsx)("span",{}),(0,o.jsx)("span",{})]}),e.sources&&e.sources.length>0&&(0,o.jsx)("div",{className:"message-sources",children:(0,o.jsxs)("details",{children:[(0,o.jsx)("summary",{children:"Sources"}),(0,o.jsx)("ul",{children:e.sources.map((e,t)=>(0,o.jsx)("li",{children:e.title||e.text?.substring(0,50)+"..."},t))})]})})]})})]})},I=({messages:e})=>{const t=(0,a.useRef)(null),s=(0,a.useRef)(null);(0,a.useEffect)(()=>{n()},[e]);const n=()=>{t.current?.scrollIntoView({behavior:"smooth"})};return(0,o.jsxs)("div",{className:"chat-message-list",ref:s,onScroll:()=>{if(s.current){const{scrollTop:e,scrollHeight:t,clientHeight:n}=s.current;if(t-e-n>100)return}},children:[e.map(e=>(0,o.jsx)(A,{message:e},e.id)),(0,o.jsx)("div",{ref:t})]})},M={sendMessage:async(e,t)=>{try{if(t){const n=await fetch(`${g}/api/v1/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e.message,session_id:e.sessionId,max_context:5})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=n.body.getReader(),a=new TextDecoder;let o="";for(;;){const{done:e,value:n}=await r.read();if(e)break;o+=a.decode(n,{stream:!0});const i=o.split("\n");o=i.pop()||"";for(const r of i)if(r.startsWith("data: "))try{const e=JSON.parse(r.slice(6));if("token"===e.type&&t)t(e.content);else if("sources"===e.type)console.log("Sources received:",e.sources);else if("complete"===e.type)break}catch(s){console.warn("Malformed JSON in stream:",r)}}return{success:!0}}{const t=await fetch(`${g}/api/v1/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e.message,session_id:e.sessionId,max_context:5})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}}catch(n){throw console.error("Error sending message:",n),n}},sendSelectedText:async e=>{try{const t=await fetch(`${g}/api/v1/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`Based on this selected text: "${e.selectedText}", please provide relevant information or answer questions about it.`,session_id:e.sessionId,max_context:5})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}catch(t){throw console.error("Error sending selected text:",t),t}},getConfig:async()=>{try{const e=await fetch(`${g}/api/v1/config/chatkit`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching config:",e),e}},checkHealth:async()=>{try{return(await fetch(`${g}/api/v1/health`)).ok}catch(e){return console.error("Error checking health:",e),!1}}},$=()=>{const[e,t]=(0,a.useState)(""),[s,n]=(0,a.useState)(!1),r=(0,a.useRef)(null),{addMessage:i,selectedText:c,sessionId:l,updateMessage:d,setIsStreaming:h}=u(),m=(0,a.useCallback)(()=>{r.current&&(r.current.style.height="auto",r.current.style.height=Math.min(r.current.scrollHeight,150)+"px")},[]),g=async()=>{if(!e.trim()||s)return;n(!0);const a=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;i({id:a,role:"user",content:e,timestamp:new Date});const o={message:e,context:{selected_text:c||null,page:"undefined"!=typeof window?window.location.pathname:""},sessionId:l},u=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;i({id:u,role:"assistant",content:"",timestamp:new Date,isStreaming:!0}),h(!0);try{await M.sendMessage(o,async e=>{d(u,{content:t=>t+e,isStreaming:!0})}),d(u,{isStreaming:!1}),t(""),r.current&&(r.current.style.height="auto")}catch(m){console.error("Error sending message:",m),d(u,{content:`Error: ${m.message}`,isStreaming:!1,error:!0})}finally{n(!1),h(!1)}},p=s;return(0,o.jsxs)("div",{className:"chat-input-bar",children:[c&&(0,o.jsxs)("div",{className:"selected-text-indicator",children:['Using selected text as context: "',c.substring(0,50),c.length>50?"...":"",'"']}),(0,o.jsxs)("div",{className:"input-container",children:[(0,o.jsx)("textarea",{ref:r,value:e,onChange:e=>{t(e.target.value),m()},onKeyDown:t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),!s&&e.trim()&&g())},placeholder:c?"Ask about the selected text...":"Message AI assistant...",className:"chat-textarea",disabled:p,rows:1}),(0,o.jsx)("button",{onClick:g,disabled:p||!e.trim(),className:"send-button "+(e.trim()?"active":""),"aria-label":"Send message",children:(0,o.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),(0,o.jsx)("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})]})]})},P=()=>{const{isOpen:e,closeChat:t}=c(),{isMobile:s}=c(),{messages:n}=u(),r=(0,a.useRef)(null);return(0,a.useEffect)(()=>{const s=e=>{!r.current||r.current.contains(e.target)||e.target.closest(".chat-launcher-button")||t()};return e&&document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[e,t]),(0,a.useEffect)(()=>{const s=e=>{"Escape"===e.key&&t()};return e&&document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[e,t]),!e||s?null:(0,o.jsx)("div",{className:"chat-panel-backdrop",children:(0,o.jsxs)("div",{className:"chat-panel",ref:r,children:[(0,o.jsxs)("div",{className:"chat-header",children:[(0,o.jsx)("h3",{children:"AI Assistant"}),(0,o.jsx)("button",{className:"close-button",onClick:t,"aria-label":"Close chat",children:"\xd7"})]}),(0,o.jsxs)("div",{className:"chat-content",children:[(0,o.jsx)(I,{messages:n}),(0,o.jsx)($,{})]})]})})},_=()=>{const{isOpen:e,closeChat:t,isMobile:s}=c(),{messages:n}=u(),r=(0,a.useRef)(null);return(0,a.useEffect)(()=>{const n=e=>{"Escape"===e.key&&t()};return e&&s&&document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[e,s,t]),e&&s?(0,o.jsx)("div",{className:"mobile-drawer-overlay",children:(0,o.jsxs)("div",{className:"mobile-drawer",ref:r,children:[(0,o.jsxs)("div",{className:"mobile-drawer-header",children:[(0,o.jsx)("button",{className:"back-button",onClick:t,"aria-label":"Back to content",children:"\u2190"}),(0,o.jsx)("h3",{children:"AI Assistant"}),(0,o.jsx)("div",{className:"header-spacer"})]}),(0,o.jsxs)("div",{className:"mobile-drawer-content",children:[(0,o.jsx)(I,{messages:n}),(0,o.jsx)($,{})]})]})}):null},L=()=>{const[e,t]=(0,a.useState)(!1),[s,n]=(0,a.useState)({top:0,left:0}),[r,i]=(0,a.useState)(""),[l,d]=(0,a.useState)(!1),h=(0,a.useRef)(null),{openChat:m}=c(),{setSelectedText:g}=u();(0,a.useEffect)(()=>{const e=()=>{const e=window.getSelection(),s=e.toString().trim();if(s.length>0&&s.length<1e3){const r=e.getRangeAt(0).getBoundingClientRect();n({top:r.top+window.scrollY-40,left:r.left+window.scrollX+r.width/2}),i(s),t(!0)}else t(!1)},s=()=>{setTimeout(e,0)};return document.addEventListener("mouseup",s),document.addEventListener("keyup",e=>{"Escape"===e.key&&t(!1)}),()=>{document.removeEventListener("mouseup",s),document.removeEventListener("keyup",e=>{"Escape"===e.key&&t(!1)})}},[]),(0,a.useEffect)(()=>{const s=e=>{h.current&&!h.current.contains(e.target)&&t(!1)};return e&&document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[e]);return e&&r?(0,o.jsx)("div",{className:"selection-tooltip "+(l?"processing":""),style:{top:`${s.top}px`,left:`${s.left}px`,transform:"translateX(-50%)"},ref:h,children:(0,o.jsx)("button",{className:"ask-ai-button",onClick:async()=>{if(r&&!l){d(!0);try{g(r),m(),window.getSelection().removeAllRanges()}catch(e){console.error("Error handling selected text:",e)}finally{d(!1),t(!1)}}},disabled:l,"aria-label":"Ask AI about selected text",children:l?(0,o.jsx)("span",{children:"Asking AI..."}):(0,o.jsx)("span",{children:"Ask AI about this"})})}):null},R=({message:e,onRetry:t,showRetry:s=!0})=>(0,o.jsxs)("div",{className:"error-bubble",children:[(0,o.jsxs)("div",{className:"error-content",children:[(0,o.jsx)("div",{className:"error-icon",children:"\u26a0\ufe0f"}),(0,o.jsx)("div",{className:"error-message",children:e})]}),s&&(0,o.jsx)("div",{className:"error-actions",children:(0,o.jsx)("button",{className:"retry-button",onClick:()=>{t&&t()},children:"Try Again"})})]})}}]);